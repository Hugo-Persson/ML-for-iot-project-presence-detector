# ML for IoT: Presence Detector

Audio-based presence detector for Arduino Nano 33 BLE/BLE Sense.

The repo supports two modes:
1. **Inference-only CNN (TFLite Micro)**: train on laptop, deploy to Arduino.
2. **Tiny model + on-device training (recommended here)**: pretrain a logistic regression on laptop, then fine-tune on-device via Serial labels.

## Demo

![Demo 1](demo1.MOV)

![Demo 2](demo2.MOV)

## Repo Layout

- `arduino/ghost_detector/ghost_detector.ino`: on-device feature extraction + inference/training.
- `arduino/ghost_detector/net.h`: exported TFLite model (CNN) used when `USE_ON_DEVICE_TRAINING=0`.
- `arduino/ghost_detector/lr_weights.h`: exported init weights for the tiny model (generated by `train_logreg.py`).
- `train_logreg.py`: trains logistic regression on your `.wav` dataset and exports `lr_weights.h`.
- `notebook.ipynb`: original CNN training + export (writes `arduino/net.h`).
- `MyProject/MyProject.ino` + `main.py`: optional data collection over Serial (IMU + audio).

## Python Setup (for pretraining/export)

If you already have a working `.venv`, you can skip this.

- Create venv: `python -m venv .venv`
- Install deps: `./.venv/bin/pip install -r requirements.txt`

## Option 2 (Recommended): Tiny Model + On-device Fine-tuning

### 1) Pretrain on laptop and export Arduino header

Run:
- `./.venv/bin/python train_logreg.py`

This trains a logistic regression on all `*.wav` in the repo root whose filename contains:
- `presence` → label `1`
- `no_presence` → label `0`

and writes:
- `arduino/ghost_detector/lr_weights.h`

Re-run anytime you add data; it will overwrite the header.

### 2) Enable on-device training in the Arduino sketch

In `arduino/ghost_detector/ghost_detector.ino`, set:
- `#define USE_ON_DEVICE_TRAINING 1`

(Optional) keep pretrained init enabled:
- `#define USE_PRETRAINED_LR_WEIGHTS 1`

Upload the sketch.

### 3) Fine-tune on the device via Serial commands

Open **Serial Monitor** at `115200` baud (line ending: **No line ending** recommended).

Send one-character commands:
- `1` → start training with label **presence**
- `0` → start training with label **no_presence**
- `x` → stop training (inference only)
- `r` → reset (reload pretrained init if available; otherwise zeros)
- `h` → print help

How to “send `1` / `0`”:
- Arduino IDE: `Tools → Serial Monitor` → type `1` in the input box → press **Enter/Send**.

Notes:
- Training updates happen every time a 2s window is ready (every 0.5s after warmup).
- Weights live in RAM; power-cycling resets them (unless you re-upload the sketch / re-run training).

## Option 1: CNN Inference (TFLite Micro)

If you want the CNN model instead of on-device training:
- In `arduino/ghost_detector/ghost_detector.ino`, set `#define USE_ON_DEVICE_TRAINING 0`
- Train/export the model from `notebook.ipynb` (it writes a model header) and make sure the generated file ends up at `arduino/ghost_detector/net.h` (either export directly there or copy it).

## Arduino IDE Setup

Install required libraries (via **Library Manager**):
- `ArduinoFFT`
- `MicroTFLite` (only needed for the CNN/TFLite path; not needed when `USE_ON_DEVICE_TRAINING=1`)

## Data Collection (Optional)

If you want to collect your own labeled audio/IMU data:
- Upload `MyProject/MyProject.ino` to stream IMU+audio over Serial.
- Run `main.py` to record a session (edit the serial port at the top of `main.py` if needed):
  - `./.venv/bin/python main.py <name> <presence|no_presence> <seconds>`

## Tuning / “Too Sensitive” Fixes (Arduino)

The sketch includes output stabilization:
- `PROB_EMA_ALPHA`: EMA smoothing for probabilities (lower = smoother, more latency).
- `PRESENCE_THRESHOLD_ON` / `PRESENCE_THRESHOLD_OFF`: hysteresis thresholds (reduces flicker).

If using on-device training, learning behavior is controlled by:
- `LR_LEARNING_RATE`, `LR_L2`

## Troubleshooting

- **Probability stuck near 0/1**: usually indicates a preprocessing mismatch; this repo scales PCM to match training (`[-1, 1]`) and matches the 207-bin feature layout.
- **No Serial commands working**: confirm baud is `115200` and you’re sending just `0`/`1` (try “No line ending”).
